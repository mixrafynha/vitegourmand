{% extends 'base.html.twig' %}

{% block title %}Redefinir senha{% endblock %}

{% block body %}
<div class="container">
  <div class="card">
    <h1>Redefinir senha</h1>
    <p>Defina uma nova senha para sua conta.</p>

    {# ✅ Token vem da rota /reset-password/{token} (atributo), ou pode vir do controller #}
    {% set resetToken = token|default(app.request.attributes.get('token')|default('')) %}

    {% if resetToken == '' %}
      <div class="error-box">
        Token inválido ou ausente. Abra o link do email novamente.
      </div>
    {% else %}
      <form id="resetForm" novalidate>
        <input type="hidden" id="token" value="{{ resetToken }}">

        <input class="input" type="password" id="password" placeholder="Nova senha" required minlength="8" autocomplete="new-password">
        <input class="input" type="password" id="password2" placeholder="Confirmar nova senha" required minlength="8" autocomplete="new-password">

        <button class="btn" type="submit">Salvar nova senha</button>
      </form>

      <div id="msg" class="msg" style="display:none;"></div>
    {% endif %}

    <a class="link" href="{{ path('app_login') }}">Voltar ao login</a>
  </div>
</div>

<script>
(() => {
  const form = document.getElementById('resetForm');
  if (!form) return;

  const msg = document.getElementById('msg');
  const btn = form.querySelector('button[type="submit"]');

  function show(text, ok=false) {
    msg.textContent = text;
    msg.className = 'msg ' + (ok ? 'msg--success' : 'msg--error');
    msg.style.display = 'block';
  }

  function hide() {
    msg.style.display = 'none';
    msg.className = 'msg';
    msg.textContent = '';
  }

  async function safeJson(res) {
    const ct = (res.headers.get('content-type') || '').toLowerCase();
    if (ct.includes('application/json')) {
      try { return await res.json(); } catch (_) { return {}; }
    }
    try { await res.text(); } catch (_) {}
    return {};
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hide();

    const token = document.getElementById('token').value.trim();
    const p1 = document.getElementById('password').value;
    const p2 = document.getElementById('password2').value;

    if (!token) return show('Token inválido ou ausente. Abra o link do email novamente.');
    if (p1.length < 8) return show('A senha deve ter no mínimo 8 caracteres.');
    if (p1 !== p2) return show('As senhas não coincidem.');

    // ✅ rota API REAL (existe no router)
    const url = "{{ path('api_auth_reset_password') }}";

    const oldText = btn.textContent;
    btn.disabled = true;
    btn.style.opacity = '0.85';
    btn.textContent = 'Salvando...';

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ token: token, password: p1, confirm: p2 })
      });

      const data = await safeJson(res);

      if (!res.ok) {
        show(data.message || `Erro (${res.status}). Tente novamente.`);
        return;
      }

      show(data.message || 'Senha atualizada com sucesso. Você já pode fazer login.', true);
      setTimeout(() => window.location.href = "{{ path('app_login') }}", 1200);

    } catch (_) {
      show('Falha de rede ao chamar a API.');
    } finally {
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.textContent = oldText;
    }
  });
})();
</script>

<style>
.container{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:16px;
  background:#f0f2f5;
}
.card{
  width:100%;
  max-width:420px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.10);
  padding:28px;
  text-align:center;
  display:flex;
  flex-direction:column;
  gap:10px;
}
h1{margin:0;color:#1e3a8a}
p{margin:0;color:#555;font-size:14px}
.input{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:14px;
  background:#fafafa;
  box-sizing:border-box;
  margin-top:8px;
}
.btn{
  width:100%;
  padding:12px;
  border:0;
  border-radius:8px;
  cursor:pointer;
  background:#16a34a;
  color:#fff;
  font-weight:800;
  margin-top:10px;
}
.btn:hover{background:#15803d}
.link{
  margin-top:8px;
  font-size:13px;
  color:#2563eb;
  text-decoration:none
}
.link:hover{text-decoration:underline}
.error-box{
  background:#fff2f2;
  border:1px solid #ffd0d0;
  color:#b00020;
  padding:10px;
  border-radius:10px;
  font-size:13px;
  margin-top:10px;
}
.msg{
  margin-top:10px;
  padding:10px;
  border-radius:10px;
  font-size:13px;
}
.msg--success{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46}
.msg--error{background:#fff2f2;border:1px solid #ffd0d0;color:#b00020}
</style>
{% endblock %}
