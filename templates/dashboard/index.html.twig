
{# templates/home/index.html.twig (com /api/dashboard depois do login) #}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Accueil - Vite & Gourmand</title>
  <link rel="stylesheet" href="{{ asset('css/style.css') }}">

  <style>
    /* ‚úÖ s√≥ para o aviso ficar bonito mesmo com teu style.css */
    .avis-item.loading { opacity:.85; }
    .avis-error { color:#dc2626; font-weight:700; }

    /* ‚úÖ Avatar dropdown no header */
    .nav-user{ position: relative; }

    .user-btn{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.85);
      cursor:pointer;
      font-weight: 800;
    }
    .user-btn:hover{ background: #fff; }

    .user-avatar{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: #111;
      color:#fff;
      font-weight: 900;
      font-size: 13px;
      flex: 0 0 auto;
    }
    .user-name{
      max-width: 140px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
      font-size: 14px;
    }
    .user-caret{ opacity:.7; }

    .user-menu{
      position:absolute;
      right: 0;
      top: calc(100% + 10px);
      width: 220px;
      background: #fff;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.18);
      padding: 8px;
      display:none;
      z-index: 9999;
    }
    .user-menu a{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: 12px;
      text-decoration:none;
      color:#111;
      font-weight: 800;
      font-size: 14px;
    }
    .user-menu a:hover{ background: rgba(0,0,0,.05); }

    .user-menu.open{ display:block; }

    @media (max-width: 520px){
      .user-name{ display:none; }
      .user-btn{ padding: 6px 8px; }
    }

    /* ‚úÖ Dashboard section (aparece s√≥ se logado) */
    #dashboardSection{
      display:none;
      margin: 26px 0 12px;
      padding: 18px;
      border-radius: 14px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(0,0,0,.08);
    }
    #dashboardCards{
      display:grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      margin-top: 14px;
    }
    .dash-card{
      background:#fff;
      padding: 16px;
      border-radius: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,.08);
    }
    .dash-card strong{ display:block; font-weight: 900; }
    .dash-card .val{ font-size: 22px; font-weight: 1000; margin-top: 6px; }
    .dash-sub{ color:#64748b; font-weight:800; margin-top: 6px; }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header>
    <nav class="main-nav">
      <div class="nav-left">
        <a href="{{ path('app_home') }}" class="nav-logo">Vite & Gourmand</a>
      </div>

      <div class="hamburger" id="hamburger">
        <span></span><span></span><span></span>
      </div>

      <div class="nav-center" id="nav-menu">
        <ul class="nav-links">
          <li>
            <a href="{{ path('app_home') }}" class="active nav-link">
              <span class="nav-text">Accueil</span>
              <span class="nav-icon">
                üè†
              </span>
            </a>
          </li>

          <li>
            <a href="{{ path('app_menu') }}" class="nav-link">
              <span class="nav-text">Menus</span>
              <span class="nav-icon">
                üçΩÔ∏è
              </span>
            </a>
          </li>

<li>
  <a href="{{ path('app_contact') }}" class="nav-link">
    <span class="nav-text">Contact</span>
    <span class="nav-icon">
      üìû
    </span>
  </a>
</li>

          <span></span>

          <!-- ‚úÖ Auth slot: Connexion ou Avatar -->
          <li id="nav-login-item">
            <a href="{{ path('app_login') }}" class="connexion" id="loginLink">Connexion</a>
          </li>

          <li id="nav-user-item" class="nav-user" style="display:none;">
            <button class="user-btn" type="button" id="userBtn" aria-haspopup="menu" aria-expanded="false">
              <span class="user-avatar" id="userAvatar">U</span>
              <span class="user-name" id="userName">Utilisateur</span>
              <span class="user-caret">‚ñæ</span>
            </button>

            <div class="user-menu" id="userMenu" role="menu" aria-label="Menu utilisateur">
              <a role="menuitem" href="/dashboard" id="accountLink">üë§ Mon compte</a>
              <a role="menuitem" href="/orders">üßæ Mes commandes</a>
              <a role="menuitem" href="{{ path('app_logout') }}" id="logoutLink">üö™ Logout</a>
            </div>
          </li>
        </ul>
      </div>
    </nav>
  </header>

  <main class="container">
    <!-- ‚úÖ Dashboard (mostra s√≥ se logado e /api/dashboard OK) -->
    <section id="dashboardSection">
      <h2 style="margin:0;">üëã Bienvenue</h2>
      <div class="dash-sub" id="dashHello"></div>

      <div id="dashboardCards"></div>
    </section>

    <!-- SECTION : HERO + PRESENTATION -->
    <section class="section-restaurant">
      <div class="section-restaurant-contenu">
        <div class="img-laterale gauche">
          <img src="{{ asset('img/img1.jpg') }}" alt="Plat du restaurant">
        </div>
        <div class="texte-central">
          <h1> Bienvenue chez Vite & Gourmand</h1>
          <h2>Restaurant raffin√© et rapide</h2>
          <p>
            Vite & Gourmand propose une cuisine fra√Æche, √©l√©gante et pr√©par√©e avec soin.
            Notre √©quipe met l‚Äôaccent sur la qualit√©, la saisonnalit√© et une pr√©sentation
            soign√©e pour offrir une exp√©rience gourmande et accessible.
          </p>
        </div>
        <div class="img-laterale droite">
          <img src="{{ asset('img/img2.jpg') }}" alt="D√©tail gastronomique">
        </div>
      </div>
    </section>

    <h2 class="h2-dark">NOTRE √âQUIPE</h2>
    <section class="team-section">
      <div class="team-grid">
        <div class="team-member">
          <img src="{{ asset('img/cook1.jpg') }}" alt="Chef 1">
          <h3>Jean Dupont</h3>
          <p>Chef Principal</p>
        </div>
        <div class="team-member">
          <img src="{{ asset('img/chef2.jpg') }}" alt="Chef 2">
          <h3>Marie Martin</h3>
          <p>Chef P√¢tissi√®re</p>
        </div>
        <div class="team-member">
          <img src="{{ asset('img/cook4.jpg') }}" alt="Chef 3">
          <h3>Lucas Bernard</h3>
          <p>Sommelier</p>
        </div>
        <div class="team-member">
          <img src="{{ asset('img/chef5.jpg') }}" alt="Chef 4">
          <h3>Claire Dubois</h3>
          <p>Ma√Ætre d'h√¥tel</p>
        </div>
      </div>
    </section>

    <!-- ‚úÖ SECTION : AVIS CLIENTS (AGORA VIA API) -->
    <section class="avis-clients" id="avisClients">
      <h2>‚≠ê Avis des Clients</h2>

      <div class="avis-grid" id="avisGrid">
        <div class="avis-item loading">
          <p>Chargement des avis‚Ä¶</p>
        </div>
      </div>
    </section>

    <section class="menu-section">
      <h2>D√âCOUVREZ LES MENUS</h2>

      <div class="menu-grid">
        <a href="{{ path('app_menu') }}" class="menu-item"><img src="{{ asset('img/1.jpg') }}" alt="Menu 1"></a>
        <a href="{{ path('app_menu') }}" class="menu-item"><img src="{{ asset('img/2.avif') }}" alt="Menu 2"></a>
        <a href="{{ path('app_menu') }}" class="menu-item"><img src="{{ asset('img/cook3.jpg') }}" alt="Menu 3"></a>
        <a href="{{ path('app_menu') }}" class="menu-item"><img src="{{ asset('img/4.avif') }}" alt="Menu 4"></a>
        <a href="{{ path('app_menu') }}" class="menu-item"><img src="{{ asset('img/5.jpg') }}" alt="Menu 5"></a>
        <a href="{{ path('app_menu') }}" class="menu-item"><img src="{{ asset('img/6.jpg') }}" alt="Menu 6"></a>
        <a href="{{ path('app_menu') }}" class="menu-item"><img src="{{ asset('img/cook5.jpg') }}" alt="Menu 7"></a>
        <a href="{{ path('app_menu') }}" class="menu-item"><img src="{{ asset('img/cook6.jpg') }}" alt="Menu 8"></a>
      </div>

      <a href="{{ path('app_menu') }}" class="menu-button">D√©couvrir les menus</a>
    </section>

    <style>
      .menu-grid{
        display:grid;
        grid-template-columns: repeat(4, 1fr);
        gap:8px;
      }
      .menu-item{ display:block; overflow:hidden; }
      .menu-item img{
        width:100%;
        height:140px;
        object-fit:cover;
        display:block;
      }
      @media (max-width: 980px){
        .menu-grid{ grid-template-columns: repeat(2, 1fr); }
      }
      @media (max-width: 520px){
        .menu-grid{ grid-template-columns: 1fr; }
        .menu-item img{ height:180px; }
      }
    </style>

  </main>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-middle">
        <span class="footer-hours">
          Horaires : Lun‚Äìdim 11h‚Äì22h
        </span>
      </div>
      <div class="footer-top">
        ¬© <span id="year"></span> <strong>Vite & Gourmand</strong> ‚Äî D√©velopp√© par <span class="brand">FastDev</span>
      </div>
      <div class="footer-links">
        <a href="{{ path('app_mentions') }}" class="footer-link">Mentions l√©gales</a>
        <a href="{{ path('app_conditions') }}" class="footer-link">Conditions g√©n√©rales</a>
        <a href="{{ path('app_cookies') }}" class="footer-link">Politique de cookies</a>
      </div>
    </div>
  </footer>
  
  <script src="{{ asset('js/script.js') }}"></script>

<script>
  const hamburger = document.getElementById("hamburger");
  const nav = document.getElementById("nav-menu");
  const mainNav = document.querySelector(".main-nav");
  const navLinks = document.querySelectorAll("#nav-menu a");

  if (hamburger && nav && mainNav) {

    hamburger.addEventListener("click", () => {
      hamburger.classList.toggle("active");
      nav.classList.toggle("active");
      mainNav.classList.toggle("menu-open"); // esconde logo
    });

    // Fecha ao clicar num link
    navLinks.forEach(link => {
      link.addEventListener("click", () => {
        hamburger.classList.remove("active");
        nav.classList.remove("active");
        mainNav.classList.remove("menu-open");
      });
    });

    // Fecha ao clicar fora
    document.addEventListener("click", (e) => {
      if (!mainNav.contains(e.target)) {
        hamburger.classList.remove("active");
        nav.classList.remove("active");
        mainNav.classList.remove("menu-open");
      }
    });

  }
</script>


  <script>
    // ‚úÖ year
    const yearEl = document.getElementById('year');
    if (yearEl) yearEl.textContent = new Date().getFullYear();

    // ‚úÖ Avis via API (contas verificadas s√£o filtradas no backend)
    (async () => {
      const grid = document.getElementById('avisGrid');
      if (!grid) return;

      const renderOne = (stars, message) => {
        const item = document.createElement('div');
        item.className = 'avis-item';

        const s = document.createElement('span');
        s.className = 'avis-stars';
        const n = Math.max(1, Math.min(5, Number(stars || 0)));
        s.textContent = '‚≠ê'.repeat(n);

        const p = document.createElement('p');
        p.textContent = message ?? '';

        item.appendChild(s);
        item.appendChild(p);
        return item;
      };

      const renderEmpty = (text, isError=false) => {
        grid.innerHTML = '';
        const item = document.createElement('div');
        item.className = 'avis-item';
        const p = document.createElement('p');
        p.textContent = text;
        if (isError) p.className = 'avis-error';
        item.appendChild(p);
        grid.appendChild(item);
      };

      try {
        const res = await fetch('/api/avis?limit=9', { headers: { 'Accept': 'application/json' } });
        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.success) {
          renderEmpty('Impossible de charger les avis.', true);
          return;
        }

        const items = Array.isArray(data.items) ? data.items : [];
        if (items.length === 0) {
          renderEmpty('Aucun avis pour le moment.');
          return;
        }

        grid.innerHTML = '';
        for (const a of items) {
          grid.appendChild(renderOne(a.stars, a.message));
        }
      } catch (e) {
        renderEmpty('Erreur serveur. R√©essayez plus tard.', true);
      }
    })();

    // ‚úÖ Dashboard via API (chama s√≥ quando logado)
    async function loadDashboard(me){
      const section = document.getElementById('dashboardSection');
      const cards = document.getElementById('dashboardCards');
      const hello = document.getElementById('dashHello');

      if (!section || !cards) return;

      try{
        const res = await fetch('/api/dashboard', {
          method: 'GET',
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });

        if(!res.ok) return;

        const data = await res.json().catch(()=>({}));
        section.style.display = 'block';

        const name = me?.firstName
          ? (me.firstName + (me.lastName ? (' ' + me.lastName) : ''))
          : (me?.email || 'Utilisateur');

        if (hello) hello.textContent = `Connect√© en tant que ${name}`;

        // ‚úÖ adapta estes campos ao que o teu /api/dashboard devolve
        const orders = Number(data.orders ?? data.ordersCount ?? 0);
        const totalSpent = Number(data.totalSpent ?? data.spent ?? 0);
        const reviews = Number(data.reviews ?? data.reviewsCount ?? 0);

        cards.innerHTML = `
          <div id="dashboardCards" style="display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));">
            <div class="dash-card">
              <strong>üßæ Commandes</strong>
              <div class="val">${orders}</div>
            </div>
            <div class="dash-card">
              <strong>üí∞ Total d√©pens√©</strong>
              <div class="val">‚Ç¨${totalSpent.toFixed(2)}</div>
            </div>
            <div class="dash-card">
              <strong>‚≠ê Avis publi√©s</strong>
              <div class="val">${reviews}</div>
            </div>
          </div>
        `;
      }catch(e){
        // se falhar, s√≥ n√£o mostra
      }
    }

    // ‚úÖ Header: esconde Connexion e mostra Avatar se /api/me OK (JWT cookie)
    (function(){
      const loginItem = document.getElementById('nav-login-item');
      const userItem  = document.getElementById('nav-user-item');

      const userBtn   = document.getElementById('userBtn');
      const userMenu  = document.getElementById('userMenu');

      const userName  = document.getElementById('userName');
      const userAvatar= document.getElementById('userAvatar');
      const accountLink = document.getElementById('accountLink');

      function openMenu() {
        userMenu.classList.add('open');
        userBtn.setAttribute('aria-expanded', 'true');
      }
      function closeMenu() {
        userMenu.classList.remove('open');
        userBtn.setAttribute('aria-expanded', 'false');
      }

      userBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        userMenu.classList.contains('open') ? closeMenu() : openMenu();
      });

      document.addEventListener('click', () => closeMenu());
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMenu(); });

      function initials(s){
        const t = String(s || '').trim();
        return t ? t[0].toUpperCase() : 'U';
      }

      async function loadMe(){
        try{
          const res = await fetch('/api/me', {
            method: 'GET',
            credentials: 'include',
            headers: { 'Accept': 'application/json' }
          });

          if (!res.ok) {
            if (loginItem) loginItem.style.display = '';
            if (userItem) userItem.style.display = 'none';
            return;
          }

          const me = await res.json().catch(() => ({}));

          if (loginItem) loginItem.style.display = 'none';
          if (userItem) userItem.style.display = '';

          const display = me.firstName
            ? (me.firstName + (me.lastName ? (' ' + me.lastName) : ''))
            : (me.email || me.username || me.userIdentifier || 'Utilisateur');

          if (userName) userName.textContent = display;
          if (userAvatar) userAvatar.textContent = initials(me.email || display);

          // opcional: se for admin, troca "Mon compte" por Admin
          const roles = Array.isArray(me.roles) ? me.roles : [];
          if (accountLink && (roles.includes('ROLE_ADMIN') || roles.includes('ROLE_SUPER_ADMIN'))) {
            accountLink.setAttribute('href', '/admin');
            accountLink.textContent = 'üõ†Ô∏è Admin';
          } else if (accountLink) {
            accountLink.setAttribute('href', '/dashboard');
            accountLink.textContent = 'üë§ Mon compte';
          }

          // ‚úÖ depois de estar logado -> chama dashboard
          loadDashboard(me);

        } catch(e) {
          if (loginItem) loginItem.style.display = '';
          if (userItem) userItem.style.display = 'none';
        }
      }

      loadMe();
    })();
  </script>
</body>
</html>
