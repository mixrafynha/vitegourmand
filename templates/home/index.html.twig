{# templates/home/index.html.twig #}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Accueil - Vite & Gourmand</title>
  <link rel="stylesheet" href="{{ asset('css/style.css') }}">

  <style>
    /* ===============================
       NAV USER + LOGIN RESPONSIVE
    ================================ */

    .nav-user{ position: relative; }

    .connexion{
      font-weight:800;
      text-decoration:none;
      color:#111;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .login-icon{
      display:none;
      font-size:18px;
    }

    .user-btn{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.85);
      cursor:pointer;
      font-weight:800;
    }

    .user-avatar{
      width:34px;
      height:34px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(135deg,#111,#444);
      color:#fff;
      font-weight:900;
      font-size:13px;
    }

    .user-name{
      max-width:140px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
      font-size:14px;
    }

    .user-caret{ opacity:.7; }

    .user-menu{
      position:absolute;
      right:0;
      top:calc(100% + 10px);
      width:220px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      border-radius:14px;
      box-shadow:0 18px 50px rgba(0,0,0,.18);
      padding:8px;
      display:none;
      z-index:9999;
    }

    .user-menu a{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      border-radius:12px;
      text-decoration:none;
      color:#111;
      font-weight:800;
      font-size:14px;
    }

    .user-menu a:hover{
      background:rgba(0,0,0,.05);
    }

    .user-menu.open{
      display:block;
    }

    /* ===============================
       MOBILE
    ================================ */

    @media (max-width:520px){

      .login-text{ display:none; }
      .login-icon{ display:inline-block; }

      .user-name{ display:none; }
      .user-caret{ display:none; }

      .user-btn{
        padding:4px;
        border:none;
        background:transparent;
      }

      .user-avatar{
        width:36px;
        height:36px;
      }
    }

    /* ===============================
       DASHBOARD
    ================================ */

    #dashboardSection{
      display:none;
      margin:26px 0;
      padding:18px;
      border-radius:14px;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.08);
    }

    #dashboardCards{
      display:grid;
      gap:14px;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      margin-top:14px;
    }

    .dash-card{
      background:#fff;
      padding:16px;
      border-radius:14px;
      box-shadow:0 10px 25px rgba(0,0,0,.08);
    }

    .dash-card strong{
      display:block;
      font-weight:900;
    }

    .dash-card .val{
      font-size:22px;
      font-weight:1000;
      margin-top:6px;
    }
  </style>
</head>

<body>

<header>
  <nav class="main-nav">

    <div class="nav-left">
      <a href="{{ path('app_home') }}" class="nav-logo">Vite & Gourmand</a>
    </div>

    <div class="nav-center">
      <ul class="nav-links">

        <li><a href="{{ path('app_home') }}">Accueil</a></li>
        <li><a href="{{ path('app_menu') }}">Menus</a></li>
        <li><a href="{{ path('app_contact') }}">Contact</a></li>

        <!-- LOGIN -->
        <li id="nav-login-item">
          <a href="{{ path('app_login') }}" class="connexion">
            <span class="login-text">Connexion</span>
            <span class="login-icon">üîê</span>
          </a>
        </li>

        <!-- USER -->
        <li id="nav-user-item" class="nav-user" style="display:none;">
          <button class="user-btn" id="userBtn">
            <span class="user-avatar" id="userAvatar">U</span>
            <span class="user-name" id="userName">Utilisateur</span>
            <span class="user-caret">‚ñæ</span>
          </button>

          <div class="user-menu" id="userMenu">
            <a href="/dashboard" id="accountLink">üë§ Mon compte</a>
            <a href="/orders">üßæ Mes commandes</a>
            <a href="{{ path('app_logout') }}">üö™ Logout</a>
          </div>
        </li>

      </ul>
    </div>

  </nav>
</header>

<main class="container">

  <!-- DASHBOARD -->
  <section id="dashboardSection">
    <h2>üëã Bienvenue</h2>
    <div id="dashboardCards"></div>
  </section>

</main>

<script>
/* ===============================
   USER AUTH LOGIC
================================ */

(function(){

  const loginItem = document.getElementById('nav-login-item');
  const userItem  = document.getElementById('nav-user-item');
  const userBtn   = document.getElementById('userBtn');
  const userMenu  = document.getElementById('userMenu');
  const userName  = document.getElementById('userName');
  const userAvatar= document.getElementById('userAvatar');

  function initials(str){
    return str ? str.charAt(0).toUpperCase() : 'U';
  }

  userBtn?.addEventListener('click', (e)=>{
    e.stopPropagation();
    userMenu.classList.toggle('open');
  });

  document.addEventListener('click', ()=>{
    userMenu.classList.remove('open');
  });

  async function loadMe(){
    try{
      const res = await fetch('/api/me', {
        credentials:'include'
      });

      if(!res.ok) return;

      const me = await res.json();

      loginItem.style.display='none';
      userItem.style.display='';

      const display = me.firstName
        ? me.firstName + (me.lastName ? ' ' + me.lastName : '')
        : me.email;

      userName.textContent = display;
      userAvatar.textContent = initials(display);

      loadDashboard();

    }catch(e){}
  }

  async function loadDashboard(){
    const section = document.getElementById('dashboardSection');
    const cards = document.getElementById('dashboardCards');

    try{
      const res = await fetch('/api/dashboard',{credentials:'include'});
      if(!res.ok) return;

      const data = await res.json();

      section.style.display='block';

      cards.innerHTML = `
        <div class="dash-card">
          <strong>üßæ Commandes</strong>
          <div class="val">${data.orders ?? 0}</div>
        </div>
        <div class="dash-card">
          <strong>üí∞ Total d√©pens√©</strong>
          <div class="val">‚Ç¨${(data.totalSpent ?? 0).toFixed(2)}</div>
        </div>
        <div class="dash-card">
          <strong>‚≠ê Avis</strong>
          <div class="val">${data.reviews ?? 0}</div>
        </div>
      `;
    }catch(e){}
  }

  loadMe();

})();
</script>

</body>
</html>
